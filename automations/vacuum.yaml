- id: vacuum_regular_cleaning
  alias: Vacuum Ask Regular Cleaning
  description: Regular vacuum cleaning every two days
  trigger:
    - platform: time_pattern
      hours: /2
      minutes: 0
      seconds: 0
  condition:
    # Robot is docked
    - condition: state
      entity_id: vacuum.roborock
      state: 'docked'
    # It's working day
    - condition: state
      entity_id: binary_sensor.workday_sensor
      state: 'on'
    # Only on activity time
    - condition: state
      entity_id: binary_sensor.activity_time
      state: 'on'
    # Do Not Disturb mode is off
    - condition: state
      entity_id: input_boolean.do_not_disturb
      state: 'off'
    # Time for cleaning or last cleaning was short
    - condition: state
      entity_id: binary_sensor.time_to_clean
      state: 'on'
    # We are not out of the city
    - condition: state
      entity_id: binary_sensor.far_from_home
      state: 'off'
  action:
    - service: script.announcement
      data:
        speak: false
        title: '–ü–∏–ª–æ—Å–æ—Å üßπ'
        messages:
          - '–ü–æ—Ä–∞ –ø–æ—á–∞—Ç–∏ —Ä–µ–≥—É–ª—è—Ä–Ω–µ –ø—Ä–∏–±–∏—Ä–∞–Ω–Ω—è.'
          - '–ß–∞—Å –ø—Ä–∏–±–∏—Ä–∞—Ç–∏ –≤–¥–æ–º–∞.'
          - '–ë–∞–∂–∞—î—Ç–µ –ø—Ä–∏–±—Ä–∞—Ç–∏ –≤–¥–æ–º–∞?'
          - '–í–¥–æ–º–∞ –¥–∞–≤–Ω–æ –Ω–µ –ø—Ä–∏–±–∏—Ä–∞–ª–∏. –ü–æ—á–∞—Ç–∏ –ø—Ä–∏–±–∏—Ä–∞–Ω–Ω—è?'
          - "{{ state_attr('vacuum.roborock', 'friendly_name') }} –ø—Ä–æ–ø–æ–Ω—É—î –¥–æ–º–∞—à–Ω—î –ø—Ä–∏–±–∏—Ä–∞–Ω–Ω—è."
          - "{{ state_attr('vacuum.roborock', 'friendly_name') }} —Ö–æ—á–µ –ø—Ä–∏–±–∏—Ä–∞—Ç–∏ –∫–≤–∞—Ä—Ç–∏—Ä—É."
          - "{{ state_attr('vacuum.roborock', 'friendly_name') }} –¥–∞–≤–Ω–æ –Ω–µ –ø—Ä–∏–±–∏—Ä–∞–≤. –ü–æ—á–∞—Ç–∏?"
        notify_data:
          push:
            category: VACUUM_ASK_CLEANING

- id: vacuum_finish_cleaning
  alias: Vacuum Stop Cleaning
  description: Send vacuum home when somebody comes home
  trigger:
    platform: state
    entity_id: group.family
    from: not_home
    to: home
  condition:
    # Send vacuum home only when it's cleaning
    - condition: state
      entity_id: vacuum.roborock
      state: 'cleaning'
  action:
    - service: vacuum.return_to_base
      entity_id: vacuum.roborock

- id: vacuum_finish_notification
  alias: Vacuum Finish Notification
  description: Notify when vacuum finished cleaning
  trigger:
    platform: state
    entity_id: vacuum.roborock
    from: 'cleaning'
    to: 'returning'
  condition:
    - condition: state
      entity_id: group.family
      state: not_home
  action:
    - service: script.announcement
      data:
        speak: false
        title: '–ü–∏–ª–æ—Å–æ—Å üßπ'
        greetings:
          - '–ü—Ä–∏–±–∏—Ä–∞–Ω–Ω—è –∑–∞–∫—ñ–Ω—á–µ–Ω–æ!'
          - '–†–æ–±–æ—Ç –ø—Ä–∏–±—Ä–∞–≤ –∫–≤–∞—Ä—Ç–∏—Ä—É!'
          - '–†–æ–±–æ—Ç –≤—Å–µ –ø—Ä–∏–±—Ä–∞–≤!'
          - '–¢–µ–ø–µ—Ä –≤–¥–æ–º–∞ —á–∏—Å—Ç–æ!'
          - "{{ state_attr('vacuum.roborock', 'friendly_name') }} –≤–∏–∫–æ–Ω–∞–≤ —Å–≤–æ—î –∑–∞–≤–¥–∞–Ω–Ω—è."
          - "{{ state_attr('vacuum.roborock', 'friendly_name') }} –∑–∞–∫—ñ–Ω—á–∏–≤ –∑ –ø—Ä–∏–±–∏—Ä–∞–Ω–Ω—è–º."
        messages:
          - '–ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—å –Ω–∞ –±–∞–∑—É!'
          - '–ù–∞–º–∞–≥–∞–π—Ç–µ—Å—å –ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –ø–æ—Ä—è–¥–æ–∫!'
          - "–ü–∞–º'—è—Ç–∞–π—Ç–µ, —â–æ —á–∏—Å—Ç–æ –Ω–µ —Ç–∞–º, –¥–µ –ø—Ä–∏–±–∏—Ä–∞—é—Ç—å, –∞ —Ç–∞–º –¥–µ –Ω–µ —Å–º—ñ—Ç—è—Ç—å!"
          - '–ü–æ–¥—è–∫—É–π—Ç–µ —Ä–æ–±–æ—Ç—É –∑–∞ –ø—Ä–∏–±–∏—Ä–∞–Ω–Ω—è ‚Äî –≤—ñ–Ω —Å—Ç–∞—Ä–∞–≤—Å—è –¥–ª—è –≤–∞—Å.'
        notify_data:
          url: /lovelace/vacuum

- id: vacuum_error_notification
  alias: Vacuum Error Notification
  description: Notify when error with vacuum occured
  trigger:
    platform: state
    entity_id: vacuum.roborock
    to: 'error'
  action:
    - service: script.announcement
      data:
        speak: false
        title: '–ü–∏–ª–æ—Å–æ—Å üßπ'
        greetings:
          - '–û–π!'
          - '–£–≤–∞–≥–∞!'
          - '–•–∞–ª–µ–ø–∞!'
        messages:
          - '–ü—Ä–æ–±–ª–µ–º–∞ –∑ –ø–∏–ª–æ—Å–æ—Å–æ–º!'
          - "–í–∏–Ω–∏–∫–ª–∞ –Ω–µ–ø–µ—Ä–µ–¥–±–∞—á—É–≤–∞–Ω–∞ —Å–∏—Ç—É–∞—Ü—ñ—è –∑ —Ä–æ–±–æ—Ç–æ–º: {{ state_attr('vacuum.roborock', 'error') }}"
          - "{{ state_attr('vacuum.roborock', 'friendly_name') }} –∑—ñ—Ç–∫–Ω—É–≤—Å—è –∑ –ø–æ–º–∏–ª–∫–æ—é."
          - "{{ state_attr('vacuum.roborock', 'friendly_name') }} –ø—Ä–æ—Å–∏—Ç—å –ø—Ä–æ –¥–æ–ø–æ–º–æ–≥—É!"
          - "{{ state_attr('vacuum.roborock', 'friendly_name') }} –ø–æ—Ç—Ä–µ–±—É—î –≤–∞—à–æ—ó –¥–æ–ø–æ–º–æ–≥–∏!"
        notify_data:
          url: /lovelace/vacuum

- id: vacuum_ask_maintenance
  alias: Vacuum Ask Maintenance
  description: Send vacuum near trash bin and ask for maintenance
  trigger:
    platform: state
    entity_id: vacuum.roborock
    to: 'docked'
  condition:
    # Every 5th cleaning
    - condition: template
      value_template: >
        {{ state_attr('vacuum.roborock', 'cleaning_count') % 5 == 0 }}
    # And there was at least one cleaning after previous maintenance
    - condition: template
      value_template: >
        {% set last_maintenance = as_timestamp(state_attr('automation.vacuum_maintenance', 'last_triggered')) | int %}
        {% set last_cleaning = as_timestamp(state_attr('vacuum.roborock', 'clean_start')) | int %}
        {{ last_cleaning > last_maintenance }}
  action:
    - service: script.announcement
      data:
        title: '–ü–∏–ª–æ—Å–æ—Å üßπ'
        greetings:
          - '–ü–æ—Ç—Ä—ñ–±–Ω–æ –æ–±—Å–ª—É–∂–∏—Ç–∏ –ø–∏–ª–æ—Å–æ—Å.'
          - '–ß–∞—Å –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è –ø–∏–ª–æ—Å–æ—Å–∞.'
          - '–†–æ–±–æ—Ç —Ç—Ä—É–¥–∏–≤—Å—è –¥–ª—è –≤–∞—Å, –∞ —Ç–µ–ø–µ—Ä –ø–æ—Ç—Ä–µ–±—É—î –≤–∞—à–æ—ó —É–≤–∞–≥–∏.'
          - "{{ state_attr('vacuum.roborock', 'friendly_name') }} –ø–æ—Ç—Ä–µ–±—É—î –ø—ñ–∫–ª—É–≤–∞–Ω–Ω—è –ø—Ä–æ —Å–µ–±–µ."
          - "{{ state_attr('vacuum.roborock', 'friendly_name') }} –ø—Ä–æ—Å–∏—Ç—å –ø—Ä–æ –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è."
        messages:
          - '–ü–æ—á–∏—Å—Ç—ñ—Ç—å –≥–∞–Ω—á—ñ—Ä–∫—É —Ç–∞ –Ω–∞–±–µ—Ä–∞—Ç–∏ —Å–≤—ñ–∂–æ—ó –≤–æ–¥–∏.'
          - '–í–∏–∫–∏–Ω—å—Ç–µ —Å–º—ñ—Ç—Ç—è —Ç–∞ –Ω–∞–±–µ—Ä—ñ—Ç—å –Ω–æ–≤–æ—ó –≤–æ–¥–∏.'
          - '–í–∏–∫–∏–Ω—å—Ç–µ —Å–º—ñ—Ç—Ç—è, –Ω–∞–±–µ—Ä—ñ—Ç—å –≤–æ–¥–∏ —ñ –ø–æ—á–∏—Å—Ç—ñ—Ç—å –≥–∞–Ω—á—ñ—Ä–∫—É.'
          - '–ü–æ—á–∏—Å—Ç—ñ—Ç—å –π–æ–≥–æ —Ç–∞ –Ω–∞–±–µ—Ä—ñ—Ç—å –Ω–æ–≤–æ—ó –≤–æ–¥–∏ —É –±–∞–∫!'
          - '–ù–∞–±–µ—Ä—ñ—Ç—å –≤–æ–¥–∏ —Ç–∞ –ø–æ—á–∏—Å—Ç—ñ—Ç—å –π–æ–≥–æ!'
        notify_data:
          push:
            category: VACUUM_ASK_MAINTENANCE
          url: /lovelace/vacuum
    - service: script.vacuum_maintenance

- id: vacuum_ios_actions_handling
  alias: Vacuum iOS Actions Handling
  trigger:
    platform: event
    event_type: ios.notification_action_fired
  action:
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ trigger.event.data.actionName == 'VACUUM_START' }}"
          sequence:
            - service: script.vacuum_regular_cleaning
        - conditions:
            - condition: template
              value_template: "{{ trigger.event.data.actionName == 'VACUUM_PAUSE' }}"
          sequence:
            - service: vacuum.pause
              entity_id: vacuum.roborock
        - conditions:
            - condition: template
              value_template: "{{ trigger.event.data.actionName == 'VACUUM_RETURN_TO_BASE' }}"
          sequence:
            - service: vacuum.return_to_base
              entity_id: vacuum.roborock

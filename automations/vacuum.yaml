- id: vacuum_regular_cleaning
  alias: Vacuum Ask Regular Cleaning
  description: Regular vacuum cleaning every two days
  trigger:
    - platform: time_pattern
      hours: /4
      minutes: 0
      seconds: 0
  condition:
    # Robot is docked
    - condition: state
      entity_id: vacuum.roborock
      state: 'docked'
    # It's working day
    - condition: state
      entity_id: binary_sensor.workday_sensor
      state: 'on'
    # Only on activity time
    - condition: state
      entity_id: binary_sensor.activity_time
      state: 'on'
    # Do Not Disturb mode is off
    - condition: state
      entity_id: input_boolean.do_not_disturb
      state: 'off'
    # Time for cleaning or last cleaning was short
    - condition: state
      entity_id: binary_sensor.time_to_clean
      state: 'on'
    # We are not out of the city
    - condition: state
      entity_id: binary_sensor.far_from_home
      state: 'off'
  action:
    - service: script.announcement
      data:
        speak: false
        title: '–ü–∏–ª–æ—Å–æ—Å üßπ'
        messages:
          - '–ü–æ—Ä–∞ –ø–æ—á–∞—Ç–∏ —Ä–µ–≥—É–ª—è—Ä–Ω–µ –ø—Ä–∏–±–∏—Ä–∞–Ω–Ω—è.'
          - '–ß–∞—Å –ø—Ä–∏–±–∏—Ä–∞—Ç–∏ –≤–¥–æ–º–∞.'
          - '–ë–∞–∂–∞—î—Ç–µ –ø—Ä–∏–±—Ä–∞—Ç–∏ –≤–¥–æ–º–∞?'
          - '–í–¥–æ–º–∞ –¥–∞–≤–Ω–æ –Ω–µ –ø—Ä–∏–±–∏—Ä–∞–ª–∏. –ü–æ—á–∞—Ç–∏ –ø—Ä–∏–±–∏—Ä–∞–Ω–Ω—è?'
          - "{{ state_attr('vacuum.roborock', 'friendly_name') }} –ø—Ä–æ–ø–æ–Ω—É—î –¥–æ–º–∞—à–Ω—î –ø—Ä–∏–±–∏—Ä–∞–Ω–Ω—è."
          - "{{ state_attr('vacuum.roborock', 'friendly_name') }} —Ö–æ—á–µ –ø—Ä–∏–±–∏—Ä–∞—Ç–∏ –∫–≤–∞—Ä—Ç–∏—Ä—É."
          - "{{ state_attr('vacuum.roborock', 'friendly_name') }} –¥–∞–≤–Ω–æ –Ω–µ –ø—Ä–∏–±–∏—Ä–∞–≤. –ü–æ—á–∞—Ç–∏?"
        notify_data:
          url: /lovelace/vacuum
          actions:
            - action: VACUUM_START
              title: –ü–æ—á–∞—Ç–∏ –ø—Ä–∏–±–∏—Ä–∞–Ω–Ω—è
              activationMode: background
              authenticationRequired: true

- id: vacuum_finish_cleaning
  alias: Vacuum Stop Cleaning
  description: Send vacuum home when somebody comes home
  trigger:
    platform: state
    entity_id: group.family
    from: not_home
    to: home
  condition:
    # Send vacuum home only when it's cleaning
    - condition: state
      entity_id: vacuum.roborock
      state: 'cleaning'
  action:
    - service: vacuum.return_to_base
      entity_id: vacuum.roborock

- id: vacuum_finish_notification
  alias: Vacuum Finish Notification
  description: Notify when vacuum finished cleaning
  trigger:
    platform: state
    entity_id: vacuum.roborock
    from: 'cleaning'
    to: 'returning'
  condition:
    - condition: state
      entity_id: group.family
      state: not_home
  action:
    - service: script.announcement
      data:
        speak: false
        title: '–ü–∏–ª–æ—Å–æ—Å üßπ'
        greetings:
          - '–ü—Ä–∏–±–∏—Ä–∞–Ω–Ω—è –∑–∞–∫—ñ–Ω—á–µ–Ω–æ!'
          - '–†–æ–±–æ—Ç –ø—Ä–∏–±—Ä–∞–≤ –∫–≤–∞—Ä—Ç–∏—Ä—É!'
          - '–†–æ–±–æ—Ç –≤—Å–µ –ø—Ä–∏–±—Ä–∞–≤!'
          - '–¢–µ–ø–µ—Ä –≤–¥–æ–º–∞ —á–∏—Å—Ç–æ!'
          - "{{ state_attr('vacuum.roborock', 'friendly_name') }} –≤–∏–∫–æ–Ω–∞–≤ —Å–≤–æ—î –∑–∞–≤–¥–∞–Ω–Ω—è."
          - "{{ state_attr('vacuum.roborock', 'friendly_name') }} –∑–∞–∫—ñ–Ω—á–∏–≤ –∑ –ø—Ä–∏–±–∏—Ä–∞–Ω–Ω—è–º."
        messages:
          - '–ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—å –Ω–∞ –±–∞–∑—É!'
          - '–ù–∞–º–∞–≥–∞–π—Ç–µ—Å—å –ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –ø–æ—Ä—è–¥–æ–∫!'
          - "–ü–∞–º'—è—Ç–∞–π—Ç–µ, —â–æ —á–∏—Å—Ç–æ –Ω–µ —Ç–∞–º, –¥–µ –ø—Ä–∏–±–∏—Ä–∞—é—Ç—å, –∞ —Ç–∞–º –¥–µ –Ω–µ —Å–º—ñ—Ç—è—Ç—å!"
          - '–ü–æ–¥—è–∫—É–π—Ç–µ —Ä–æ–±–æ—Ç—É –∑–∞ –ø—Ä–∏–±–∏—Ä–∞–Ω–Ω—è ‚Äî –≤—ñ–Ω —Å—Ç–∞—Ä–∞–≤—Å—è –¥–ª—è –≤–∞—Å.'
        notify_data:
          url: /lovelace/vacuum

- id: vacuum_error_notification
  alias: Vacuum Error Notification
  description: Notify when error with vacuum occured
  trigger:
    platform: state
    entity_id: vacuum.roborock
    to: 'error'
  action:
    - service: script.announcement
      data:
        speak: false
        title: '–ü–∏–ª–æ—Å–æ—Å üßπ'
        greetings:
          - '–û–π!'
          - '–£–≤–∞–≥–∞!'
          - '–•–∞–ª–µ–ø–∞!'
        messages:
          - '–ü—Ä–æ–±–ª–µ–º–∞ –∑ –ø–∏–ª–æ—Å–æ—Å–æ–º!'
          - "–í–∏–Ω–∏–∫–ª–∞ –Ω–µ–ø–µ—Ä–µ–¥–±–∞—á—É–≤–∞–Ω–∞ —Å–∏—Ç—É–∞—Ü—ñ—è –∑ —Ä–æ–±–æ—Ç–æ–º: {{ state_attr('vacuum.roborock', 'error') }}"
          - "{{ state_attr('vacuum.roborock', 'friendly_name') }} –∑—ñ—Ç–∫–Ω—É–≤—Å—è –∑ –ø–æ–º–∏–ª–∫–æ—é."
          - "{{ state_attr('vacuum.roborock', 'friendly_name') }} –ø—Ä–æ—Å–∏—Ç—å –ø—Ä–æ –¥–æ–ø–æ–º–æ–≥—É!"
          - "{{ state_attr('vacuum.roborock', 'friendly_name') }} –ø–æ—Ç—Ä–µ–±—É—î –≤–∞—à–æ—ó –¥–æ–ø–æ–º–æ–≥–∏!"
        notify_data:
          url: /lovelace/vacuum

- id: vacuum_ask_maintenance
  alias: Vacuum Ask Maintenance
  description: Send vacuum near trash bin and ask for maintenance
  trigger:
    platform: state
    entity_id: vacuum.roborock
    to: 'docked'
  condition:
    # Every 5th cleaning
    - condition: template
      value_template: >
        {{ state_attr('vacuum.roborock', 'cleaning_count') % 5 == 0 }}
    # And there was at least one cleaning after previous maintenance
    - condition: template
      value_template: >
        {% set last_maintenance = as_timestamp(state_attr('automation.vacuum_maintenance', 'last_triggered')) | int %}
        {% set last_cleaning = as_timestamp(states('sensor.roborock_last_clean_start')) | int %}
        {{ last_cleaning > last_maintenance }}
  action:
    - service: script.announcement
      data:
        title: '–ü–∏–ª–æ—Å–æ—Å üßπ'
        greetings:
          - '–ü–æ—Ç—Ä—ñ–±–Ω–æ –æ–±—Å–ª—É–∂–∏—Ç–∏ –ø–∏–ª–æ—Å–æ—Å.'
          - '–ß–∞—Å –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è –ø–∏–ª–æ—Å–æ—Å–∞.'
          - '–†–æ–±–æ—Ç —Ç—Ä—É–¥–∏–≤—Å—è –¥–ª—è –≤–∞—Å, –∞ —Ç–µ–ø–µ—Ä –ø–æ—Ç—Ä–µ–±—É—î –≤–∞—à–æ—ó —É–≤–∞–≥–∏.'
          - "{{ state_attr('vacuum.roborock', 'friendly_name') }} –ø–æ—Ç—Ä–µ–±—É—î –ø—ñ–∫–ª—É–≤–∞–Ω–Ω—è –ø—Ä–æ —Å–µ–±–µ."
          - "{{ state_attr('vacuum.roborock', 'friendly_name') }} –ø—Ä–æ—Å–∏—Ç—å –ø—Ä–æ –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è."
        messages:
          - '–ü–æ—á–∏—Å—Ç—ñ—Ç—å –≥–∞–Ω—á—ñ—Ä–∫—É —Ç–∞ –Ω–∞–±–µ—Ä–∞—Ç–∏ —Å–≤—ñ–∂–æ—ó –≤–æ–¥–∏.'
          - '–í–∏–∫–∏–Ω—å—Ç–µ —Å–º—ñ—Ç—Ç—è —Ç–∞ –Ω–∞–±–µ—Ä—ñ—Ç—å –Ω–æ–≤–æ—ó –≤–æ–¥–∏.'
          - '–í–∏–∫–∏–Ω—å—Ç–µ —Å–º—ñ—Ç—Ç—è, –Ω–∞–±–µ—Ä—ñ—Ç—å –≤–æ–¥–∏ —ñ –ø–æ—á–∏—Å—Ç—ñ—Ç—å –≥–∞–Ω—á—ñ—Ä–∫—É.'
          - '–ü–æ—á–∏—Å—Ç—ñ—Ç—å –π–æ–≥–æ —Ç–∞ –Ω–∞–±–µ—Ä—ñ—Ç—å –Ω–æ–≤–æ—ó –≤–æ–¥–∏ —É –±–∞–∫!'
          - '–ù–∞–±–µ—Ä—ñ—Ç—å –≤–æ–¥–∏ —Ç–∞ –ø–æ—á–∏—Å—Ç—ñ—Ç—å –π–æ–≥–æ!'
        notify_data:
          url: /lovelace/vacuum
          actions:
            - identifier: VACUUM_PAUSE
              title: '–ü–∞—É–∑–∞'
              activationMode: 'background'
            - identifier: VACUUM_RETURN_TO_BASE
              title: '–ù–∞ –±–∞–∑—É'
              activationMode: 'background'
              destructive: true
    - service: script.vacuum_maintenance

- id: vacuum_replacements
  alias: Vacuum Replacements Alert
  trigger:
    - platform: numeric_state
      id: main_brush
      entity_id: vacuum.roborock
      attribute: main_brush_left
      below: 1
    - platform: numeric_state
      id: side_brush
      entity_id: vacuum.roborock
      attribute: side_brush_left
      below: 1
    - platform: numeric_state
      id: filter
      entity_id: vacuum.roborock
      attribute: filter_left
      below: 1
    - platform: numeric_state
      id: sensor_dirty
      entity_id: vacuum.roborock
      attribute: sensor_dirty_left
      below: 1
  action:
    - choose:
        - conditions:
            - condition: trigger
              id: main_brush
          sequence:
            - service: script.announcement
              data:
                title: '–ü–∏–ª–æ—Å–æ—Å üßπ'
                greetings:
                  - '–ì–æ–ª–æ–≤–Ω–∞ —â—ñ—Ç–∫–∞ –ø–æ—Ç—Ä–µ–±—É—î –∑–∞–º—ñ–Ω–∏.'
                  - '–ü–æ—Ç—Ä—ñ–±–Ω–æ –∑–∞–º—ñ–Ω–∏—Ç–∏ –æ—Å–Ω–æ–≤–Ω—É —â—ñ—Ç–∫—É.'
                  - '–ó–∞–º—ñ–Ω—ñ—Ç—å –æ—Å–Ω–æ–≤–Ω—É —â—ñ—Ç–∫—É.'
                messages:
                  - '–ù–µ –∑–∞–±—É–¥—å—Ç–µ –æ–±–Ω—É–ª–∏—Ç–∏ –ª—ñ—á–∏–ª—å–Ω–∏–∫ –ø—ñ—Å–ª—è –∑–∞–º—ñ–Ω–∏ —Ç–∞ –∑–∞–º–æ–≤–∏—Ç–∏ –Ω–æ–≤—É —â—ñ—Ç–∫—É.'
                  - '–û–±–Ω—É–ª—ñ—Ç—å –ª—ñ—á–∏–ª—å–Ω–∏–∫ –ø—ñ—Å–ª—è –∑–∞–º—ñ–Ω–∏ —Ç–∞ –∑–∞–º–æ–≤—Ç–µ –Ω–æ–≤—É —â—ñ—Ç–∫—É.'
                notify_data:
                  url: /lovelace/vacuum
                  actions:
                    - identifier: VACUUM_GO_TO_MAINTENANCE
                      title: '–û–±—Å–ª—É–∂–∏—Ç–∏'
                      activationMode: 'background'
                      destructive: true
                    - identifier: VACUUM_RETURN_TO_BASE
                      title: '–ù–∞ –±–∞–∑—É'
                      activationMode: 'background'
                      destructive: true
        - conditions:
            - condition: trigger
              id: side_brush
          sequence:
            - service: script.announcement
              data:
                title: '–ü–∏–ª–æ—Å–æ—Å üßπ'
                greetings:
                  - '–ë–æ–∫–æ–≤–∞ —â—ñ—Ç–∫–∞ –ø–æ—Ç—Ä–µ–±—É—î –∑–∞–º—ñ–Ω–∏.'
                  - '–ü–æ—Ç—Ä—ñ–±–Ω–æ –∑–∞–º—ñ–Ω–∏—Ç–∏ –±–æ–∫–æ–≤—É —â—ñ—Ç–∫—É.'
                  - '–ó–∞–º—ñ–Ω—ñ—Ç—å –±–æ–∫–æ–≤—É —â—ñ—Ç–∫—É.'
                messages:
                  - '–ù–µ –∑–∞–±—É–¥—å—Ç–µ –æ–±–Ω—É–ª–∏—Ç–∏ –ª—ñ—á–∏–ª—å–Ω–∏–∫ –ø—ñ—Å–ª—è –∑–∞–º—ñ–Ω–∏ —Ç–∞ –∑–∞–º–æ–≤–∏—Ç–∏ –Ω–æ–≤—É —â—ñ—Ç–∫—É.'
                  - '–û–±–Ω—É–ª—ñ—Ç—å –ª—ñ—á–∏–ª—å–Ω–∏–∫ –ø—ñ—Å–ª—è –∑–∞–º—ñ–Ω–∏ —Ç–∞ –∑–∞–º–æ–≤—Ç–µ –Ω–æ–≤—É —â—ñ—Ç–∫—É.'
                notify_data:
                  url: /lovelace/vacuum
                  actions:
                    - identifier: VACUUM_GO_TO_MAINTENANCE
                      title: '–û–±—Å–ª—É–∂–∏—Ç–∏'
                      activationMode: 'background'
                      destructive: true
                    - identifier: VACUUM_RETURN_TO_BASE
                      title: '–ù–∞ –±–∞–∑—É'
                      activationMode: 'background'
                      destructive: true
        - conditions:
            - condition: trigger
              id: filter
          sequence:
            - service: script.announcement
              data:
                title: '–ü–∏–ª–æ—Å–æ—Å üßπ'
                greetings:
                  - '–û—Å–Ω–æ–≤–Ω–∏–π —Ñ—ñ–ª—å—Ç—Ä –ø–æ—Ç—Ä–µ–±—É—î –∑–∞–º—ñ–Ω–∏.'
                  - '–ü–æ—Ç—Ä—ñ–±–Ω–æ –∑–∞–º—ñ–Ω–∏—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä –ø–∏–ª–æ—Å–æ—Å–∞.'
                  - '–ó–∞–º—ñ–Ω—ñ—Ç—å —Ñ—ñ–ª—å—Ç—Ä –ø–∏–ª–æ—Å–æ—Å–∞.'
                messages:
                  - '–ù–µ –∑–∞–±—É–¥—å—Ç–µ –æ–±–Ω—É–ª–∏—Ç–∏ –ª—ñ—á–∏–ª—å–Ω–∏–∫ –ø—ñ—Å–ª—è –∑–∞–º—ñ–Ω–∏ —Ç–∞ –∑–∞–º–æ–≤–∏—Ç–∏ –Ω–æ–≤–∏–π —Ñ—ñ–ª—å—Ç—Ä.'
                  - '–û–±–Ω—É–ª—ñ—Ç—å –ª—ñ—á–∏–ª—å–Ω–∏–∫ –ø—ñ—Å–ª—è –∑–∞–º—ñ–Ω–∏ —Ç–∞ –∑–∞–º–æ–≤—Ç–µ –Ω–æ–≤–∏–π —Ñ—ñ–ª—å—Ç—Ä.'
                notify_data:
                  url: /lovelace/vacuum
                  actions:
                    - identifier: VACUUM_GO_TO_MAINTENANCE
                      title: '–û–±—Å–ª—É–∂–∏—Ç–∏'
                      activationMode: 'background'
                      destructive: true
                    - identifier: VACUUM_RETURN_TO_BASE
                      title: '–ù–∞ –±–∞–∑—É'
                      activationMode: 'background'
                      destructive: true
        - conditions:
            - condition: trigger
              id: sensor_dirty
          sequence:
            - service: script.announcement
              data:
                title: '–ü–∏–ª–æ—Å–æ—Å üßπ'
                greetings:
                  - '–°–µ–Ω—Å–æ—Ä–∏ –æ—Ä—ñ—î–Ω—Ç–∞—Ü—ñ—ó –∑–∞–±—Ä—É–¥–Ω–∏–ª–∏—Å—å.'
                  - '–ü–æ—Ç—Ä—ñ–±–Ω–æ –æ—á–∏—Å—Ç–∏—Ç–∏ —Å–µ–Ω—Å–æ—Ä–∏ –ø–∏–ª–æ—Å–æ—Å–∞.'
                  - '–û—á–∏—Å—Ç—ñ—Ç—å —Å–µ–Ω—Å–æ—Ä–∏ –ø–∏–ª–æ—Å–æ—Å–∞.'
                messages:
                  - '–ù–µ –∑–∞–±—É–¥—å—Ç–µ –æ–±–Ω—É–ª–∏—Ç–∏ –ª—ñ—á–∏–ª—å–Ω–∏–∫ –ø—ñ—Å–ª—è –æ—á–∏—â–µ–Ω–Ω—è.'
                  - '–û–±–Ω—É–ª—ñ—Ç—å –ª—ñ—á–∏–ª—å–Ω–∏–∫ –ø—ñ—Å–ª—è –æ—á–∏—â–µ–Ω–Ω—è.'
                notify_data:
                  url: /lovelace/vacuum
                  actions:
                    - identifier: VACUUM_GO_TO_MAINTENANCE
                      title: '–û–±—Å–ª—É–∂–∏—Ç–∏'
                      activationMode: 'background'
                      destructive: true
                    - identifier: VACUUM_RETURN_TO_BASE
                      title: '–ù–∞ –±–∞–∑—É'
                      activationMode: 'background'
                      destructive: true

- id: vacuum_ios_actions_handling
  alias: Vacuum iOS Actions Handling
  trigger:
    platform: event
    event_type: mobile_app_notification_action
  action:
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ trigger.event.data.action == 'VACUUM_START' }}"
          sequence:
            - service: script.vacuum_regular_cleaning
        - conditions:
            - condition: template
              value_template: "{{ trigger.event.data.action == 'VACUUM_PAUSE' }}"
          sequence:
            - service: vacuum.pause
              entity_id: vacuum.roborock
        - conditions:
            - condition: template
              value_template: "{{ trigger.event.data.action == 'VACUUM_RETURN_TO_BASE' }}"
          sequence:
            - service: vacuum.return_to_base
              entity_id: vacuum.roborock
        - conditions:
            - condition: template
              value_template: "{{ trigger.event.data.action == 'VACUUM_GO_TO_MAINTENANCE' }}"
          sequence:
            - service: script.vacuum_maintenance

- id: everyones_arriving
  alias: Everyone is Arriving
  description: Turn on things when people are arriving
  trigger:
    platform: state
    entity_id: group.family
    from: 'not_home'
    to: 'home'
  action:
    # Wait for someone to come
    - wait_for_trigger:
        - platform: state
          entity_id: binary_sensor.front_door_sensor_contact
          to: 'on'
        - platform: state
          entity_id: binary_sensor.living_room_movement_sensor_occupancy
          to: 'on'
        - platform: state
          entity_id: binary_sensor.bedroom_movement_sensor_occupancy
          to: 'on'
      timeout: '01:00:00'
      continue_on_timeout: false
    # Turn on fans
    - service: fan.turn_on
      entity_id: all
    # Turn on lights after sunset
    - choose:
        - conditions:
            - condition: state
              entity_id: binary_sensor.evening_time
              state: 'on'
          sequence:
            - service: scene.turn_on
              data:
                entity_id: scene.evening_lights
                transition: 5
        - conditions:
            - condition: state
              entity_id: binary_sensor.night_time
              state: 'on'
          sequence:
            - service: scene.turn_on
              data:
                entity_id: scene.night_lights
                transition: 5
    - delay:
        seconds: 5
    - service: script.greeting

- id: everyones_leaving
  alias: Everyone is Leaving
  description: Turn off things when people are leaving
  trigger:
    platform: state
    entity_id: group.family
    from: 'home'
    to: 'not_home'
    for: '00:10:00'
  action:
    - service: fan.turn_off
      entity_id: all
    - service: light.turn_off
      entity_id: all
    - service: climate.turn_off
      entity_id: all
    - service: media_player.turn_off
      entity_id: all
    - choose:
        - conditions:
            - condition: state
              entity_id: binary_sensor.time_to_clean
              state: 'on'
          sequence:
            - service: script.announcement
              data:
                speak: false
                title: '–ü–∏–ª–æ—Å–æ—Å üßπ'
                messages:
                  - '–†–æ–±–æ—Ç –ø–æ—á–∞–≤ –ø—Ä–∏–±–∏—Ä–∞–Ω–Ω—è.'
                  - '–ü—Ä–∏–±–∏—Ä–∞–Ω–Ω—è —Ä–æ–∑–ø–æ—á–∞—Ç–æ.'
                  - "{{ state_attr('vacuum.roborock', 'friendly_name') }} –ø–æ—á–∞–≤ –ø—Ä–∏–±–∏—Ä–∞—Ç–∏."
                  - "{{ state_attr('vacuum.roborock', 'friendly_name') }} –ø—Ä–∏–±–∏—Ä–∞—î –∫–≤–∞—Ä—Ç–∏—Ä—É."
                notify_data:
                  push:
                    category: VACUUM_REGULAR_CLEANING
            - service: script.vacuum_regular_cleaning

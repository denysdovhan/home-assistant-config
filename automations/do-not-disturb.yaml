- id: do_not_disturb
  alias: Do Not Disturb Flow
  description: Adjust devices to Do Not Disturb mode
  mode: queued
  trigger:
    - platform: homeassistant
      event: start
    - platform: state
      entity_id: input_boolean.do_not_disturb
  action:
    # Speakers
    - service: media_player.volume_set
      data:
        entity_id: media_player.all_speakers
        volume_level: >
          {% if not is_state('media_player.all_speakers', 'playing') %}
            {% if is_state('input_boolean.do_not_disturb', 'on') %}
              0.20
            {% else %}
              0.75
            {% endif %}
          {% endif %}
    # Purifier
    # Set Purifier speed only when it's running
    - service: fan.set_speed
      entity_id: fan.purifier
      data:
        speed: >
          {% if is_state('fan.purifier', 'on') %}
            {% if is_state('input_boolean.do_not_disturb', 'on') %}
              Silent
            {% else %}
              Auto
            {% endif %}
          {% endif %}
    # Humidifier
    - service: >
        {% if is_state('input_boolean.do_not_disturb', 'on') %}
          xiaomi_miio_airpurifier.fan_set_led_off
        {% else %}
          xiaomi_miio_airpurifier.fan_set_led_on
        {% endif %}
      entity_id: fan.humidifier

- id: do_not_disturb_while_sleeping_time
  alias: Do Not Disturb while Sleeping Time
  description: Switch Do Not Disturb along with Sleeping Time
  trigger:
    - platform: homeassistant
      event: start
    - platform: state
      entity_id: binary_sensor.sleeping_time
  action:
    - service: input_boolean.turn_{{ states('binary_sensor.sleeping_time') }}
      entity_id: input_boolean.do_not_disturb

- id: do_not_disturb_on_calls
  alias: Do Not Disturb on calls
  description: Switch Do Not Disturb while camera or mics are on
  trigger:
    - platform: state
      entity_id: binary_sensor.wix_macbook_pro_camera_in_use
    - platform: state
      entity_id: binary_sensor.wix_macbook_pro_microphone_in_use
    - platform: state
      entity_id: binary_sensor.home_macbook_pro_camera_in_use
    - platform: state
      entity_id: binary_sensor.home_macbook_pro_microphone_in_use
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: states('binary_sensor.sleeping_time')
              state: 'off'
          sequence:
            - service: input_boolean.turn_{{ trigger.to_state.state }}
              entity_id: input_boolean.do_not_disturb
